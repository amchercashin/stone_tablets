<!DOCTYPE html>
<html>
<head>
    <script>
        
        window.addEventListener('load', function() {

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof web3 !== 'undefined') {
            // Use Mist/MetaMask's provider
            window.web3 = new Web3(web3.currentProvider);
        } else {
            console.log('No web3? You should consider trying MetaMask!')
            // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
            window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }

        })

        function make_table() {
            var tablet_factory_address = document.getElementById("tablet_factory").value;
            var tablet_factory_ABI = [{"constant":false,"inputs":[{"name":"record","type":"string"}],"name":"add_record","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"new_owner","type":"address"}],"name":"change_owner","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"scribe","type":"address"}],"name":"remove_scribe","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"records","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"tablet_owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"scribe","type":"address"}],"name":"add_scribe","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"tablet_length","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"scribes","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"tablet_creator","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"tablet_creator","type":"address"},{"indexed":false,"name":"tablet_address","type":"address"}],"name":"new_tablet_created","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"tablet_address","type":"address"},{"indexed":true,"name":"scribe","type":"address"},{"indexed":false,"name":"record_nubmer","type":"uint256"}],"name":"new_record","type":"event"}];
            var tablet_factory = web3.eth.contract(tablet_factory_ABI);
            var tablet_factory_instance = tablet_factory.at(tablet_factory_address);
            var new_tablet_calculated_address;
            tablet_factory_instance.create_tablet.call({},
                function(error, result){
                    if(!error) {                    
                        new_tablet_calculated_address = result;
                        console.log("new_tablet_calculated_address: " + new_tablet_calculated_address);
                        //console.log(tablet_factory_instance);
                        tablet_factory_instance.creator_tablets_count.call(web3.eth.accounts[0],
                            function(error, result){
                                if(!error) {
                                    var creator_tablets_count = result;
                                    console.log("creator_tablets_count: " + creator_tablets_count);
                                    tablet_factory_instance.create_tablet({from:web3.eth.accounts[0], to:tablet_factory, value:"", gas:850000, gasPrice:"4000000000"},
                                        function(error, result){
                                            if(!error) {
                                                console.log("Create tablet tx sent, hash: " + result)
                                                while (is_created = false) {
                                                    setTimeout(is_created = tablet_is_created(tablet_factory_instance, web3.eth.accounts[0], 
                                                                                            new_tablet_calculated_address, 
                                                                                            creator_tablets_count), 10000);
                                                }
                                                document.getElementById("new_tablet_address").innerHTML = new_tablet_calculated_address;
                                            }
                                            else {
                                                console.error(error);
                                            }
                                        }
                                    );
                                }
                                else {
                                    console.error(error);
                                }
                            }    
                        );
                    }
                    else {
                        console.error(error);
                    }
                }
            );

    
        }
    
        function tablet_is_created(tablet_factory_instance, creator, tablet_address, tablet_n) {
            tablet_factory_instance.tablets.call({creator, tablet_n}, function(error, result) {
                if(!error) {
                    console.log("tablet_address: " + tablet_address + "/n" + "result: " + result);
                    return tablet_address == result;
                } else {
                    console.error(error);
                }
            })            
        }

    </script>
</head>

<body>
    <fieldset>
        <legend><h1>Make new stone table</h1></legend>
        
        Input tablet factory address: <br>
        <input type="text" size="42" id="tablet_factory"></input>
        <input type="button" value="create tablet" onclick="make_table()"></p>

        <p>Tablet address: <code style="background-color:gainsboro;" id="new_tablet_address"></code></p>

    </fieldset>

</body>
</html>