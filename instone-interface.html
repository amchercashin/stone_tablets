<!DOCTYPE html>
<html>
<head>
    <script>
        
        window.addEventListener('load', function() {

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof web3 !== 'undefined') {
            // Use Mist/MetaMask's provider
            window.web3 = new Web3(web3.currentProvider);
        } else {
            console.log('No web3? You should consider trying MetaMask!')
            // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
            window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }

        })

        function make_table() {
            var tablet_factory_address = document.getElementById("tablet_factory").value;
            var tablet_factory_ABI = [{"constant":true,"inputs":[],"name":"creators_count","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"create_tablet","outputs":[{"name":"","type":"address"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"},{"name":"","type":"uint256"}],"name":"tablets","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"creator_address","type":"address"}],"name":"is_creator","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"creators","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"tablet_creator","type":"address"},{"indexed":false,"name":"tablet_address","type":"address"},{"indexed":true,"name":"block_number","type":"uint256"},{"indexed":true,"name":"block_time","type":"uint256"},{"indexed":false,"name":"creators_count","type":"uint256"}],"name":"new_tablet_created","type":"event"}];
            var tablet_factory = web3.eth.contract(tablet_factory_ABI);
            var tablet_factory_instance = tablet_factory.at(tablet_factory_address);
            var new_tablet_calculated_address;
            tablet_factory_instance.create_tablet.call({},
                function(error, result){
                    if(!error) {                    
                        new_tablet_calculated_address = result;
                        console.log("new_tablet_calculated_address: " + new_tablet_calculated_address);
                        tablet_factory_instance.create_tablet({from:web3.eth.accounts[0], to:tablet_factory, value:"", gas:850000, gasPrice:"4000000000"},
                            function(error, result){
                                if(!error) {
                                    console.log("Create tablet tx sent, hash: " + result)
                                    
                                }
                                else {
                                    console.error(error);
                                }
                            }
                        );
                    }
                    else {
                        console.error(error);
                    }
                }
            );

    
        }

    </script>
</head>

<body>
    <fieldset>
        <legend><h1>Make new stone table</h1></legend>
        
        Input tablet factory address: <br>
        <input type="text" size="42" id="tablet_factory"></input>
        <input type="button" value="create tablet" onclick="make_table()"></p>

        <p>Tablet address: <code style="background-color:gainsboro;" id="new_tablet_address"></code></p>

    </fieldset>

</body>
</html>