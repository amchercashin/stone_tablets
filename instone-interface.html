<!DOCTYPE html>
<html>
<head>
    <style>
        .pending {
            -webkit-animation: pending 2s infinite;
        }
        
        @-webkit-keyframes pending
        {
        0% {opacity:0.3;}
        20% {opacity:0.3;}
        40% {opacity:.7;}
        60% {opacity:1;}
        80% {opacity:0.7;}
        100% {opacity:0.3;}
        }
            </style>
    <script>
        
        window.addEventListener('load', function() {

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof web3 !== 'undefined') {
            // Use Mist/MetaMask's provider
            window.web3 = new Web3(web3.currentProvider);
        } else {
            console.log('No web3? You should consider trying MetaMask!')
            // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
            window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }

        })

        function make_table() {
            var tablet_factory_instance = get_tablet_factory_instance();
            console.log(tablet_factory_instance);
            var new_tablet_calculated_address;
            var desired_tablet_name = document.getElementById("desired_tablet_name").value
            tablet_factory_instance.create_tablet.call(desired_tablet_name,
                function(error, result){
                    if(!error) {                    
                        new_tablet_calculated_address = result;
                        console.log("new_tablet_calculated_address: " + new_tablet_calculated_address);
                        //console.log(tablet_factory_instance);
                        tablet_factory_instance.creator_tablets_count.call(web3.eth.accounts[0],
                            function(error, result){
                                if(!error) {
                                    var creator_tablets_count = result;
                                    console.log("creator_tablets_count: " + creator_tablets_count);
                                    tablet_factory_instance.create_tablet(desired_tablet_name, {from:web3.eth.accounts[0], to:tablet_factory, value:"", gas:850000, gasPrice:"4000000000"},
                                        function(error, result){
                                            if(!error) {
                                                document.getElementById("new_tablet_address").innerHTML = "pending table creation";
                                                document.getElementById("new_tablet_address").className = "pending";
                                                console.log("Create tablet tx sent, hash: " + result)
                                                var is_created = false;
                                                var tablet_listener = setInterval(
                                                    function() {
                                                        tablet_is_created(tablet_factory_instance, web3.eth.accounts[0], 
                                                                                        new_tablet_calculated_address, 
                                                                                        creator_tablets_count, is_created, tablet_listener);                                                        
                                                    }
                                                , 10000);                                                
                                            }
                                            else {
                                                console.error(error);
                                            }
                                        }
                                    );
                                }
                                else {
                                    console.error(error);
                                }
                            }    
                        );
                    }
                    else {
                        console.error(error);
                    }
                }
            );

    
        }

        function get_tablet_factory_instance () {
            var tablet_factory_address = document.getElementById("tablet_factory").value;
            var tablet_factory_ABI = [{"constant":true,"inputs":[],"name":"creators_count","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"new_tablet_name","type":"bytes32"}],"name":"create_tablet","outputs":[{"name":"","type":"address"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"},{"name":"","type":"uint256"}],"name":"tablets","outputs":[{"name":"tablet_name","type":"bytes32"},{"name":"tablet_address","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"creator_address","type":"address"}],"name":"is_creator","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"creators","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"creator_address","type":"address"}],"name":"creator_tablets_count","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}];
            var tablet_factory = web3.eth.contract(tablet_factory_ABI);
            return tablet_factory.at(tablet_factory_address);
        }
    
        function tablet_is_created(tablet_factory_instance, creator, tablet_address, tablet_n, is_created, tablet_listener) {
            tablet_factory_instance.tablets.call(creator, tablet_n, function(error, result) {
                if(!error) {
                    console.log("tablet_address: " + tablet_address + "/n" + "result: " + result[1]);
                    is_created = tablet_address == result[1];
                    if (is_created) {
                        document.getElementById("new_tablet_address").innerHTML = tablet_address;
                        document.getElementById("new_tablet_address").className = "";
                        clearInterval(tablet_listener);
                    }
                } else {
                    console.error(error);
                }
            })
        }

        function show_tablets() {
            var creator_address = web3.eth.accounts[0];
            var tablet_factory_instance = get_tablet_factory_instance();
             console.log(tablet_factory_instance);
            tablet_factory_instance.creator_tablets_count.call(creator_address,
                function(error, tablets_count){
                    if (!error) {
                        var my_tablets_table_html = 
                        `
                        <table>
                            <tr>
                                <th>Name</th>
                                <th>Address</th>
                            </tr>                        
                        `
                        console.log("tablets_count "+tablets_count)
                        var t;
                        for (t = 0; t < tablets_count; t++) {
                            console.log(t);
                            tablet_factory_instance.tablets.call(creator_address, t, function(error, tablet) {
                                if (!error) {
                                    console.log(tablet);
                                    var new_tablet_html = `
                                    <tr>
                                        <td>` + tablet[0] + `</td>
                                        <td>` + tablet[1] + `</td>
                                    </tr>
                                    `
                                    my_tablets_table_html = my_tablets_table_html + new_tablet_html;
                                    document.getElementById("my_tablets").innerHTML = my_tablets_table_html + " </table>";
                                }
                                else {
                                    console.log(error);
                                }
                            })                           
                        }
                        
                    } else {
                        console.error(error);
                    }
                }
            );
        }
    </script>
</head>

<body>
    <fieldset>
        <legend><h1>Make new stone tablet</h1></legend>
        
        Input tablet factory address: <br>
        <input type="text" size="42" id="tablet_factory"></input> 
        
        <p>Desired tablet name:<br>
        <input id="desired_tablet_name" type="text" maxlength=32 size=32 pattern="^[0-9a-fA-F]$">
        <input type="button" value="create tablet" onclick="make_table()"></p>

        <p>Tablet address:<br><code style="background-color:gainsboro;" id="new_tablet_address"></code></p>

    </fieldset>

    <fieldset>
            <legend><h1>Show your tablets</h1></legend>
            
            Choose desired addres in MetaMask then click <br>
            <input type="button" value="show my tablets" onclick="show_tablets()"></p>
    
            <p id="my_tablets"></p>
    
    </fieldset>

</body>
</html>